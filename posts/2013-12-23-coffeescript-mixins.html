<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>On CoffeeScript Mixins - Pang Yan Han's blog</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Pang Yan Han">
        <link rel="stylesheet" href="../css/normalize.css">
        <link rel="stylesheet" href="../css/foundation.min.css">
        <link rel="stylesheet" href="../css/responsive-nav.css">
        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="../css/my-pygments-colorscheme.css">
        <link rel="stylesheet" href="../css/main.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">

        <script src="../js/vendor/modernizr.js"></script>
        <script src="../js/responsive-nav.min.js"></script>
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
            tex2jax: {
              inlineMath: [ ["\\(", "\\)"] ],
              processEscapes: true
            }
          });
        </script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-49506023-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-49506023-1');
        </script>
    </head>

    <body>
      <div class="site">
        <div class="row">
          <div class="small-6 columns">
            <h1 class="title"><a href="../">Pang Yan Han's blog</a></h1>
          </div>
          <div class="small-6 columns">
            <div class="header-icons header-icons-translate show-for-medium-up">
              <a href="../atom.xml" target="_blank">
                <i class="fa fa-rss-square fa-4x"></i>
              </a>
              <a href="https://github.com/yanhan" target="_blank">
                <i class="fa fa-github-alt fa-4x"></i>
              </a>
              <a href="http://sg.linkedin.com/pub/yan-han-pang/92/158/91b" target="_blank">
                <i class="fa fa-linkedin fa-4x"></i>
              </a>
              <a href="https://twitter.com/yanhan_pang" target="_blank">
                <i class="fa fa-twitter fa-4x"></i>
              </a>
            </div>
            <div class="header-icons show-for-small-only">
              <a href="../atom.xml" target="_blank">
                <i class="fa fa-rss-square fa-2x"></i>
              </a>
              <a href="https://github.com/yanhan" target="_blank">
                <i class="fa fa-github-alt fa-2x"></i>
              </a>
              <a href="http://sg.linkedin.com/pub/yan-han-pang/92/158/91b" target="_blank">
                <i class="fa fa-linkedin fa-2x"></i>
              </a>
              <a href="https://twitter.com/yanhan_pang" target="_blank">
                <i class="fa fa-twitter fa-2x"></i>
              </a>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="small-12 columns">
            <nav class="header nav-collapse">
              <ul>
                <li><a class="extra" href="../">home</a></li>
                <li><a class="extra" href="../about.html">about</a></li>
                <li><a class="extra" href="../bookshelf.html">bookshelf</a></li>
                <li><a class="extra" href="../interesting-talks.html">interesting talks</a></li>
                <li><a class="extra" href="../archive.html">archive</a></li>
              </ul>
            </nav>
          </div>
        </div>

        <div class="row">
          <div class="small-12 columns">
            <h2>On CoffeeScript Mixins</h2>
<p class="meta">
  23 Dec 2013,
  
    by <span class="italic">Pang Yan Han</span>
  
</p>
<div class="post-tags">
  <i class="fa fa-tags"></i>Tags: <a href="../tags/coffeescript.html">coffeescript</a>, <a href="../tags/mixins.html">mixins</a>, <a href="../tags/javascript.html">javascript</a>
</div>
<div class="post">
  <p>CoffeeScript offers some rather nice improvements over JavaScript. One feature which I personally find very useful is the inclusion of classes. While JavaScript’s prototypal inheritance is powerful, I was exposed to more traditional OO languages prior to JavaScript, and I find that classes are a more intuitive way to organize code.</p>
<p><a href="http://arcturo.github.io/library/coffeescript/03_classes.html">Chapter 3</a> of the <a href="http://arcturo.github.io/library/coffeescript/">Little Book on CoffeeScript</a> offers a quick and dirty overview of classes in CoffeeScript. But that is not our main topic of the evening. Instead, we shall take a little look at <strong>Mixins</strong>, also explained in the same chapter.</p>
<p>Personally, I am rather new to the concept of Mixins. It was only through some Ruby work that I was first exposed to this idea. In short, Mixins are a way to <strong>mimick</strong> multiple inheritance. Now, before an angry mob of programmers kill me, I think we all agree that in general, multiple inheritance is a bad idea, but it does have its advantages. Mixins are a way of getting the best out of both worlds, gaining the power of multiple inheritance while keeping class hierarchies as a tree.</p>
<p>To understand Mixins, let us take a look at a rather contrived example in Ruby.</p>
<p>Suppose we have a <code>ComputerMonitor</code> class, which is a subclass of the <code>Display</code> class. However, we also want it to have the functionality of the <code>BlackObject</code> class (yea my monitors usually have black frames; I know this example is <em>really</em> contrived, but bear with me for a moment). How we will do it in Ruby is, instead of having <code>BlackObject</code> as a class, we organize it as a <strong>Module</strong>. So the <code>ComputerMonitor</code> class will <strong>extend</strong> the <code>Display</code> class, and <strong>include</strong> the <code>BlackObject</code> module, like this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ComputerMonitor</span> <span class="o">&lt;</span> <span class="no">Display</span>
  <span class="kp">include</span> <span class="no">BlackObject</span>
</pre></div>

<p>We can immediately see several advantages of this approach, which makes use of Mixins:</p>
<ul>
<li>Our classes have single inheritance hierarchies</li>
<li>AND we have the power of multiple inheritance on our side</li>
<li>Code which is more generic and can be reused across different classes are organized as Modules</li>
</ul>
<p>And while I’m pretty new to this, I think my last point should be particularly true for Mixins. The code should be sufficiently generic to permit reuse across several classes, otherwise, we might as well put the code inside the class making use of it in the first place.</p>
<p>Since the above example is very contrived, here’s a more real world example. In Ruby, the <code>Array</code> and <code>Hash</code> classes are blueprints for the very indispensable data structures. When we do an <code>ri Array</code>, we see the following:</p>
<div class="figure">
<img src="../images/2013-12-23/ri_array.png" />

</div>
<p>and when we do an <code>ri Hash</code>, we see the following:</p>
<div class="figure">
<img src="../images/2013-12-23/ri_hash.png" />

</div>
<p>See any similarities? They both include <code>Enumberable</code>, hence they share a lot of methods. An <code>ri Enumerable</code> confirms that yes, <code>Enumerable</code> is a Mixin:</p>
<div class="figure">
<img src="../images/2013-12-23/ri_enumerable.png" />

</div>
<p>So I hope that is sufficiently real world, and an ok introduction to Mixins. Now, onto how they are implemented in CoffeeScript.</p>
<h2 id="mixins-in-coffeescript">Mixins in CoffeeScript</h2>
<p>By default, CoffeeScript does not have Mixins as a built-in language feature. However, it is possible to implement them in CoffeeScript, as the <strong>Mixins</strong> section of <a href="http://arcturo.github.io/library/coffeescript/03_classes.html">Chapter 3</a> of the Little Book on CoffeeScript shows us.</p>
<p>That said, the full-fledged code for enabling Mixins in CoffeeScript is at the <strong>Extending classes</strong> section, which is right after the <strong>Mixins</strong> section. Here is the code:</p>
<div class="highlight"><pre><span></span><span class="nv">moduleKeywords = </span><span class="p">[</span><span class="s">'extended'</span><span class="p">,</span> <span class="s">'included'</span><span class="p">]</span>

<span class="k">class</span> <span class="nx">Module</span>
  <span class="vi">@extend: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span> <span class="k">when</span> <span class="nx">key</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">moduleKeywords</span>
      <span class="nx">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">extended</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="k">this</span>

  <span class="vi">@include: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span> <span class="k">when</span> <span class="nx">key</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">moduleKeywords</span>
      <span class="c1"># Assign properties to the prototype</span>
      <span class="nx">@</span><span class="o">::</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">included</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="k">this</span>
</pre></div>

<p>We will use <code>include</code> for “instance level” Mixins, in other words, to mix in methods or properties we want to appear in every <strong>instantiated object</strong> of the class and its descendents. We will use <code>extend</code> for “class level” Mixins, which adds the methods or properties of the given object onto the <strong>class</strong> itself, which makes this kind of like static methods/attributes in C++ / Java.</p>
<p>The book provides an example usage:</p>
<div class="highlight"><pre><span></span><span class="nv">classProperties =</span>
  <span class="nv">find: </span><span class="nf">(id) -&gt;</span>
  <span class="nv">create: </span><span class="nf">(attrs) -&gt;</span>

<span class="nv">instanceProperties =</span>
  <span class="nv">save: </span><span class="nf">-&gt;</span>

<span class="k">class</span> <span class="nx">User</span> <span class="k">extends</span> <span class="nx">Module</span>
  <span class="nx">@extend</span> <span class="nx">classProperties</span>
  <span class="nx">@include</span> <span class="nx">instanceProperties</span>

<span class="c1"># Usage:</span>
<span class="nv">user = </span><span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="nv">user = </span><span class="k">new</span> <span class="nx">User</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
</pre></div>

<p>Here, we see that the <code>User</code> class inherits from <code>Module</code>. All the magic enabling Mixins is in the <code>Module</code> class, so having a class inheriting the <code>Module</code> class is a prerequisite to enabling Mixins.</p>
<p>Here, we see that the <code>User</code> class <code>@extends</code> the <code>classProperties</code> object. So the <code>find</code> and <code>create</code> methods are available on the <code>User</code> class itself (and descendent classes), but <strong>not</strong> <code>User</code> objects.</p>
<p>The <code>User</code> class <code>@includes</code> the <code>instanceProperties</code> object. As such, the <code>save</code> method is available on <code>User</code> <strong>objects</strong>, and objects which are instances of classes that descend from <code>User</code>.</p>
<p>From here, we can see that, for a class to use Mixins:</p>
<ol style="list-style-type: decimal">
<li>It has to inherit from <code>Module</code> (or a class with similar functionality)</li>
<li>Either use the <code>@extend</code> or <code>@include</code>, and pass in an <strong>object</strong> to those functions. That object will contain the methods / properties we want to mix in to the class. We can write the methods as if they belong to a class (meaning that we can use the <code>@</code> notation)</li>
</ol>
<p>Now then, I skipped some details that I wish to go back to. Let’s take a look at the code for the <code>Module</code> class again:</p>
<div class="highlight"><pre><span></span><span class="nv">moduleKeywords = </span><span class="p">[</span><span class="s">'extended'</span><span class="p">,</span> <span class="s">'included'</span><span class="p">]</span>

<span class="k">class</span> <span class="nx">Module</span>
  <span class="vi">@extend: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span> <span class="k">when</span> <span class="nx">key</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">moduleKeywords</span>
      <span class="nx">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">extended</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="k">this</span>

  <span class="vi">@include: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span> <span class="k">when</span> <span class="nx">key</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">moduleKeywords</span>
      <span class="c1"># Assign properties to the prototype</span>
      <span class="nx">@</span><span class="o">::</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">included</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="k">this</span>
</pre></div>

<p>When I first looked at this, several questions came into mind:</p>
<ol style="list-style-type: decimal">
<li>what is the use of the <strong>moduleKeywords</strong> variable?</li>
<li>what are the <code>obj.extended?.apply(@)</code> lines doing?</li>
<li>why use <code>@[key] = value</code> for <code>@extend</code>, but <code>@::[key] = value</code> for <code>@include</code> ?</li>
</ol>
<p>All these questions can be answered by looking at the last example given in Chapter 3 of the Little Book on CoffeeScript:</p>
<div class="highlight"><pre><span></span><span class="nv">ORM =</span>
  <span class="nv">find: </span><span class="nf">(id) -&gt;</span>
  <span class="nv">create: </span><span class="nf">(attrs) -&gt;</span>
  <span class="nv">extended: </span><span class="nf">-&gt;</span>
    <span class="nx">@include</span>
      <span class="nv">save: </span><span class="nf">-&gt;</span>

<span class="k">class</span> <span class="nx">User</span> <span class="k">extends</span> <span class="nx">Module</span>
  <span class="nx">@extend</span> <span class="nx">ORM</span>
</pre></div>

<p>Essentially, this example is doing exactly the same thing as the example where we had the <code>User</code> class <code>@extend</code> the <code>classProperties</code> object and <code>@include</code> the <code>instanceProperties</code> object (so the <code>User</code> class will possess the <code>find</code> and <code>create</code> class methods, and the <code>save</code> instance method). But how can that be, they look so different. Yet it is truly the case. Let’s go into a bit more detail.</p>
<p>Let’s start from the definition of the <code>User</code> class:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nx">User</span> <span class="k">extends</span> <span class="nx">Module</span>
  <span class="nx">@extend</span> <span class="nx">ORM</span>
</pre></div>

<p>This should probably be familiar to us by now. It will call the <code>@extend</code> method of the <code>Module</code> class, with the <code>ORM</code> object passed in. Let’s look at how <code>@extend</code> is defined inside the <code>Module</code> class:</p>
<div class="highlight"><pre><span></span>  <span class="vi">@extend: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span> <span class="k">when</span> <span class="nx">key</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">moduleKeywords</span>
      <span class="nx">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">extended</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="k">this</span>
</pre></div>

<p>our <code>ORM</code> object has the <code>find</code>, <code>create</code> and <code>extended</code> properties. There is something subtle with the name of the function. By writing it as <code>@extend</code> instead of <code>extend</code>, we are actually creating <code>extend</code> as a <strong>class method</strong>. Use of the <a href="http://js2coffee.org/#coffee2js">js2coffee</a> tool confirms this.</p>
<p>The <code>@extend</code> function is compiled to the following JavaScript:</p>
<div class="highlight"><pre><span></span>  <span class="nx">Module</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">__indexOf</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">moduleKeywords</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">extended</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_ref</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
</pre></div>

<p>Changing <code>@extend</code> to <code>extend</code> causes the same snippet of code to be compiled to:</p>
<div class="highlight"><pre><span></span>  <span class="nx">Module</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">__indexOf</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">moduleKeywords</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">extended</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_ref</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
</pre></div>

<p>Notice how everything stays the same, except that <code>Module.extend</code> becomes <code>Module.prototype.extend</code>. As such, since the function is defined as <code>@extend</code>, the <code>@</code> refers to the Module <strong>class</strong>. This is why passing the an object to <code>@extend</code> will cause the object’s properties to be available to the target class.</p>
<p>In a similar spirit, for <code>@include</code>:</p>
<div class="highlight"><pre><span></span>  <span class="vi">@include: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span> <span class="k">when</span> <span class="nx">key</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">moduleKeywords</span>
      <span class="c1"># Assign properties to the prototype</span>
      <span class="nx">@</span><span class="o">::</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">included</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="k">this</span>
</pre></div>

<p>the code is compiled to the following JavaScript:</p>
<div class="highlight"><pre><span></span>  <span class="nx">Module</span><span class="p">.</span><span class="nx">include</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">__indexOf</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">moduleKeywords</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">included</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_ref</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
</pre></div>

<p>Notice how <code>@::[key] = value</code> is compiled to <code>this.prototype[key] = value;</code>. This is what makes the properties of the object available to the <strong>instances</strong> of the target class.</p>
<p>Going back to <code>@extend</code>:</p>
<div class="highlight"><pre><span></span>  <span class="vi">@extend: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span> <span class="k">when</span> <span class="nx">key</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">moduleKeywords</span>
      <span class="nx">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">extended</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="k">this</span>
</pre></div>

<p>Recall that the <code>ORM</code> object we passed in to <code>@extend</code> has 3 properties: <code>find</code>, <code>create</code> and <code>extended</code>. So what the code here is doing is, for any key that is not in the <code>moduleKeywords</code> variable, make them available to the class.</p>
<p>It happens that <code>moduleKeywords</code> is defined as follows:</p>
<div class="highlight"><pre><span></span><span class="nv">moduleKeywords = </span><span class="p">[</span><span class="s">'extended'</span><span class="p">,</span> <span class="s">'included'</span><span class="p">]</span>
</pre></div>

<p>and we see that <code>extended</code> is in <code>moduleKeywords</code>, so that property is not added to the <code>User</code> class.</p>
<p>We are done with the <code>for</code> loop in the <code>@extend</code> method, so now we are at this intimidating line:</p>
<div class="highlight"><pre><span></span>    <span class="nx">obj</span><span class="p">.</span><span class="nx">extended</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
</pre></div>

<p><code>obj.extended?</code> checks if <code>obj</code> has a property called <code>extended</code>. If so, then call its <code>apply</code> method, with <code>this</code> bounded to <code>@</code>. Taking another look at the <code>ORM</code> object we passed in to <code>@extend</code>:</p>
<div class="highlight"><pre><span></span><span class="nv">ORM =</span>
  <span class="nv">find: </span><span class="nf">(id) -&gt;</span>
  <span class="nv">create: </span><span class="nf">(attrs) -&gt;</span>
  <span class="nv">extended: </span><span class="nf">-&gt;</span>
    <span class="nx">@include</span>
      <span class="nv">save: </span><span class="nf">-&gt;</span>
</pre></div>

<p>We see that the <code>ORM</code> object has an <code>extended</code> property, which happens to be a function. In JavaScript (and hence CoffeeScript), Functions have the <code>apply</code> method (details <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/apply">here</a>), which takes in 1 argument, and simply calls the function with <code>this</code> becoming that supplied argument.</p>
<p>In other words, <code>obj.extended?.apply(@)</code> will call the <code>ORM.extended</code> function, replacing <code>this</code> with <code>@</code> (here, <code>@</code> refers to the <code>User</code> <strong>class</strong>). Inside <code>ORM.extended</code>, we have an <code>@include</code> function call, with the argument being an object with the <code>save</code> property. I think it should be clear what this is doing - it is a roundabout way of <code>@include</code>’ing an object with the <code>save</code> function to the <code>User</code> class. So hopefully this paragraph in Chapter 3 of The Little Book on CoffeeScript makes sense now, especially with regards to the callbacks:</p>
<pre>
As you can see, we've added some static properties, find() and create() to the
User class, as well as some instance properties, save(). Since we've got
callbacks whenever modules are extended, we can shortcut the process of
applying both static and instance properties:
</pre>
<p>Pretty neat, huh? I didn’t figure all that out by myself. All the credit goes to these 2 questions on Stack Overflow, and their answers:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/12839183/using-mixins-in-coffeescript" class="uri">http://stackoverflow.com/questions/12839183/using-mixins-in-coffeescript</a></li>
<li><a href="http://stackoverflow.com/questions/8728074/coffeescript-javascript-mixins-idiot-seeking-explanation" class="uri">http://stackoverflow.com/questions/8728074/coffeescript-javascript-mixins-idiot-seeking-explanation</a></li>
</ul>
<p>This post is really just an organization of the wonderful chapter inside The Little Book of CoffeeScript, and knowledge gained from the 2 questions above. Hopefully there aren’t too many mistakes. Haha</p>
</div>
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pangyanhan'; // required: replace example with your forum shortname
        var disqus_identifier = "posts/2013-12-23-coffeescript-mixins.md";
        var disqus_url = "http://blog.pangyanhan.com/posts/2013-12-23-coffeescript-mixins.html";

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

          </div>
        </div>

        <div class="row footer">
          <div class="medium-12 columns">
            <div class="footer-item">
              <span>Github</span>
              <a href="https://github.com/yanhan/">github.com/yanhan</a>
            </div>
            <div class="hakyll-line">
              Site proudly generated by
              <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
            </div>
          </div>
        </div>
      </div>

      <script src="../js/vendor/jquery.js"></script>
      <script src="../js/foundation.min.js"></script>
      <script>
        $(document).foundation();
        var navigation = responsiveNav(".nav-collapse", {
          animate: true,
          transition: 284,
          label: "",
          insert: "after",
          openPos: "relative",
          navActiveClass: "js-nav-active"
        });
      </script>
    </body>
</html>
