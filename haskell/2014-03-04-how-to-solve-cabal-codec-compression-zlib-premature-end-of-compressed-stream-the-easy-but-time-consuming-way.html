<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>How to solve "cabal: Codec.Compression.Zlib: premature end of compressed stream" - the easy but time consuming way - Yan Han's blog</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Pang Yan Han">
        <link rel="stylesheet" href="../css/normalize.css">
        <link rel="stylesheet" href="../css/foundation.min.css">
        <link rel="stylesheet" href="../css/responsive-nav.css">
        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="../css/my-pygments-colorscheme.css">
        <link rel="stylesheet" href="../css/main.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">

        <script src="../js/vendor/modernizr.js"></script>
        <script src="../js/responsive-nav.min.js"></script>
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
            tex2jax: {
              inlineMath: [ ["\\(", "\\)"] ],
              processEscapes: true
            }
          });
        </script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
    </head>

    <body>
      <div class="site">
        <div class="row">
          <div class="small-6 columns">
            <h1 class="title"><a href="../">yan han's blog</a></h1>
          </div>
          <div class="small-6 columns">
            <div class="header-icons header-icons-translate show-for-medium-up">
              <a href="../atom.xml" target="_blank">
                <i class="fa fa-rss-square fa-4x"></i>
              </a>
              <a href="https://github.com/yanhan" target="_blank">
                <i class="fa fa-github-alt fa-4x"></i>
              </a>
              <a href="http://sg.linkedin.com/pub/yan-han-pang/92/158/91b" target="_blank">
                <i class="fa fa-linkedin fa-4x"></i>
              </a>
              <a href="https://twitter.com/yanhan_pang" target="_blank">
                <i class="fa fa-twitter fa-4x"></i>
              </a>
            </div>
            <div class="header-icons show-for-small-only">
              <a href="../atom.xml" target="_blank">
                <i class="fa fa-rss-square fa-2x"></i>
              </a>
              <a href="https://github.com/yanhan" target="_blank">
                <i class="fa fa-github-alt fa-2x"></i>
              </a>
              <a href="http://sg.linkedin.com/pub/yan-han-pang/92/158/91b" target="_blank">
                <i class="fa fa-linkedin fa-2x"></i>
              </a>
              <a href="https://twitter.com/yanhan_pang" target="_blank">
                <i class="fa fa-twitter fa-2x"></i>
              </a>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="small-12 columns">
            <nav class="header nav-collapse">
              <ul>
                <li><a class="extra" href="../">home</a></li>
                <li><a class="extra" href="../about.html">about</a></li>
                <li><a class="extra" href="../haskell">Haskell</a></li>
                <li><a class="extra" href="../bookshelf.html">bookshelf</a></li>
                <li><a class="extra" href="../interesting-talks.html">interesting talks</a></li>
                <li><a class="extra" href="../archive.html">archive</a></li>
              </ul>
            </nav>
          </div>
        </div>

        <div class="row">
          <div class="small-12 columns">
            <h2>How to solve "cabal: Codec.Compression.Zlib: premature end of compressed stream" - the easy but time consuming way</h2>
<p class="meta">
  04 Mar 2014,
  
    by <span class="italic">Pang Yan Han</span>
  
</p>
<div class="post-tags">
  <i class="fa fa-tags"></i>Tags: <a href="../tags/haskell.html">haskell</a>
</div>
<div class="post">
  <h2 id="tldr">TLDR</h2>
<p>If you are already extremely frustrated by this problem, the solution is just:</p>
<div class="highlight"><pre><span></span>cd ~/.cabal/packages/hackage.haskell.org
rm -rf *
cabal update
</pre></div>

<p>followed by a <code>cabal install X</code> where X is some package you’d like to install.</p>
<h2 id="longer-version">Longer version</h2>
<p>Doesn’t it irk you when you do a <code>cabal install somepackage</code>, and somewhere along the way you see something like:</p>
<div class="highlight"><pre><span></span>Configuring zlib-bindings-0.1.1.3...
Building zlib-bindings-0.1.1.3...
Preprocessing library zlib-bindings-0.1.1.3...
[1 of 2] Compiling Codec.Zlib.Lowlevel ( Codec/Zlib/Lowlevel.hs, dist/dist-sandbox-a9ff9784/build/Codec/Zlib/Lowlevel.o )
[2 of 2] Compiling Codec.Zlib       ( Codec/Zlib.hs, dist/dist-sandbox-a9ff9784/build/Codec/Zlib.o )
In-place registering zlib-bindings-0.1.1.3...
Installing library in
/home/yh/haskellsandbox/hakyll-4.4.2.0/.cabal-sandbox/lib/x86_64-linux-ghc-7.4.1/zlib-bindings-0.1.1.3
Registering zlib-bindings-0.1.1.3...
Installed zlib-bindings-0.1.1.3
cabal: Codec.Compression.Zlib: premature end of compressed stream
Done.
Failed to install 'hakyll-4.4.2.0'
</pre></div>

<p>It’s the dreaded <code>cabal: Codec.Compression.Zlib: premature end of compressed stream</code> error. Googling for this error shows you advice dating years back, asking you to check your network connection, inspect the output of <code>cabal update -v 3</code>, removing the <code>~/.cabal/packages/hackage.haskell.org/00-index.tar.gz</code> file, and so on.</p>
<p>I don’t know about you, but none of the advice / answers worked for me. Don’t get me wrong, it’s sound advice, but it’s completely useless if the same error pops up when I do another <code>cabal update</code> followed by <code>cabal install</code>.</p>
<p>However, let’s take a closer look at the error message:</p>
<div class="highlight"><pre><span></span>cabal: Codec.Compression.Zlib: premature end of compressed stream
</pre></div>

<p>and combine this with the advice of removing the <code>~/.cabal/packages/hackage.haskell.org/00-index.tar.gz</code> file. Does that ring a bell?</p>
<p>On curiosity (and frustration after <code>cabal install</code> failed repeatedly), I thought the error might have to do with uncompressing <strong>some other</strong> compressed file that is not <code>~/.cabal/packages/hackage.haskell.org/00-index.tar.gz</code>, and set out to execute:</p>
<div class="highlight"><pre><span></span>find ~/.cabal -type f -name '*.gz'
</pre></div>

<p>and I was rewarded with a whole bunch of <code>tar.gz</code> files under <code>~/.cabal/packages/hackage.haskell.org</code> in their package directories.</p>
<p>I was impatient and quite frustrated at this point, so I proceeded with:</p>
<div class="highlight"><pre><span></span>cd ~/.cabal/packages/hackage.haskell.org
rm -rf *
</pre></div>

<p>thereby removing everything, under <code>~/.cabal/packages/hackage.haskell.org</code>, whether good or bad.</p>
<p>This is followed by:</p>
<div class="highlight"><pre><span></span>cabal update
</pre></div>

<p>After which, I proceeded with the <code>cabal install</code>, which successfully installs the package.</p>
<p>As such, my guess is correct. <strong>Some</strong> <code>tar.gz</code> file within <code>~/.cabal/packages/hackage.haskell.org</code> is corrupted, causing the error, just not <code>~/.cabal/packages/hackage.haskell.org/00-index.tar.gz</code>.</p>
<p>Why do I call this the easy but time consuming way? Because we delete all previously downloaded packages, regardless of whether they are corrupted or otherwise. Subsequent cabal operations could have made use of the working packages. Now, missing packages must be downloaded, which does take a little time.</p>
<p>A more clever solution will be to check every single <code>tar.gz</code> file under <code>~/.cabal/packages/hackage.haskell.org</code> and only delete the corrupted ones. This should not be too difficult to do.</p>
</div>
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pangyanhan'; // required: replace example with your forum shortname
        var disqus_identifier = "haskell/2014-03-04-how-to-solve-cabal-codec-compression-zlib-premature-end-of-compressed-stream-the-easy-but-time-consuming-way.markdown";
        var disqus_url = "http://blog.pangyanhan.com/haskell/2014-03-04-how-to-solve-cabal-codec-compression-zlib-premature-end-of-compressed-stream-the-easy-but-time-consuming-way.html";

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

          </div>
        </div>

        <div class="row footer">
          <div class="medium-12 columns">
            <div class="footer-item">
              <span>Github</span>
              <a href="https://github.com/yanhan/">github.com/yanhan</a>
            </div>
            <div class="hakyll-line">
              Site proudly generated by
              <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
            </div>
          </div>
        </div>
      </div>

      <script src="../js/vendor/jquery.js"></script>
      <script src="../js/foundation.min.js"></script>
      <script>
        $(document).foundation();
        var navigation = responsiveNav(".nav-collapse", {
          animate: true,
          transition: 284,
          label: "",
          insert: "after",
          openPos: "relative",
          navActiveClass: "js-nav-active"
        });
      </script>
      <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-49506023-1', 'pangyanhan.com');ga('send', 'pageview');</script>
    </body>
</html>
